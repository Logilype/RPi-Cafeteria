<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CafDS Dashboard - Angebote bearbeiten</title>
 <!-- Corrected font weights -->
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="header">
        CafDS Dashboard
        <button id="logoutBtn">Ausloggen</button>
    </div>
    <div class="navbar" id="navbar">
        <div class="navbar-item">
            <a href="/panel">Home</a>
        </div>
        <div class="navbar-item-selected">
            <a href="/panel/offers">Angebote bearbeiten</a>
        </div>
        <div class="navbar-item">
            <a href="/panel/menu">Speiseplan verwalten/bearbeiten</a>
        </div>
        <div class="navbar-item">
            <a href="/panel/menuentries">Speiseplaneinträge verwalten</a>
        </div>
        <div class="navbar-item">
            <a href="/panel/advertising">Werbung bearbeiten</a>
        </div>
        <div class="navbar-item">
            <a href="/panel/media">Medien verwalten</a>
        </div>
        <div class="navbar-item">
            <a href="/panel/settings">Einstellungen</a>
        </div>
    </div>
    <div class="content">
        <div class="tables">
            <div class="grid-container">
                (renderanchor) <!-- This will be replaced with the actual entries -->
            </div>
        </div>
        <div class="actionbuttons">
            <input type="button" value="Hinzufügen" id="newbtn">
            <input type="button" value="Aktualisieren Senden" id="refreshbtn">
        </div>
    </div>
    <div class="footer">
        <a href="https://github.com/logilype/cafeteria-digital-signage">© Logilype & Felixmax_ 2024</a>
    </div>
    <!-- Modal for editing entry -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Eintrag bearbeiten</h2>
            <form id="editForm">
                <input type="hidden" id="editId" name="id">
                <label for="editName">Name:</label>
                <input type="text" id="editName" name="name" required>
                <label for="editPrice">Preis:</label>
                <div style="display: flex; align-items: center;">
                    <input type="number" id="editEuro" name="euro" min="0" max="9" style="width: 40px;" required>
                    <span>,</span>
                    <input type="number" id="editCent" name="cent" min="0" max="99" maxlength="2" style="width: 50px;" required>
                    <span>€</span>
                </div>
                <label for="editImage">Bild:</label>
                <div class="custom-dropdown">
                    <div class="selected-image" id="selectedImage" onclick="toggleDropdown()">
                        <img id="previewImage" src="" alt="Selected Image" style="display: none;">
                    </div>
                    <div class="dropdown-list" id="imageDropdownList" style="display: none;">
                        <!-- Options will be populated dynamically -->
                    </div>
                </div>
                <input type="hidden" id="editImage" name="image">
                <label for="editDays">Tage:</label>
                <input type="text" id="editDays" name="days" required>
                <input type="hidden" id="editVisibility" name="visibility">
                <span class="toggleVisibilityTxt">Wird nicht angezeigt</span>
                <label class="toggle">
                    <input type="checkbox" id="toggleVisibilityBtn">
                    <span class="slider round"></span>
                </label>
                <button type="submit" id="saveEditBtn">Speichern</button>
            </form>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const modal = document.getElementById("editModal");
            const closeModal = document.getElementsByClassName("close")[0];

            // Function to open the modal
            window.openEditModal = function(item) {
                document.getElementById("editId").value = item.id;
                document.getElementById("editName").value = item.name;
                const euros = Math.floor(item.price);
                const cents = Math.round((item.price - euros) * 100);
                document.getElementById('editEuro').value = euros;
                document.getElementById('editCent').value = cents;
                document.getElementById("editDays").value = item.days;
                document.getElementById("editVisibility").value = item.visibility;
                document.getElementById("toggleVisibilityBtn").checked = item.visibility;

                const toggleText = document.querySelector('.toggleVisibilityTxt');
                toggleText.textContent = item.visibility ? 'Wird angezeigt' : 'Wird nicht angezeigt';

                const imageDropdownList = document.getElementById("imageDropdownList");
                imageDropdownList.innerHTML = '';

                fetch('/api/getImages')
                    .then(response => response.json())
                    .then(images => {
                        images.forEach(image => {
                            const option = document.createElement("div");
                            option.innerHTML = `<img src="${image}" alt="${image}">`;
                            option.onclick = function() {
                                document.getElementById("previewImage").src = image;
                                document.getElementById("previewImage").style.display = "block";
                                document.getElementById("editImage").value = image;
                                imageDropdownList.style.display = "none";
                            };
                            imageDropdownList.appendChild(option);
                        });

                        const currentImage = item.image;
                        document.getElementById("previewImage").src = currentImage;
                        document.getElementById("previewImage").style.display = "block";
                        document.getElementById("editImage").value = currentImage;
                    })
                    .catch(error => console.error('Error fetching images:', error));

                modal.style.display = "flex";
            };

            closeModal.onclick = function() {
                modal.style.display = "none";
            };

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            };

            // Handle form submission
            document.getElementById("editForm").addEventListener("submit", function(event) {
                event.preventDefault(); // Prevent the default form submission

                const id = document.getElementById("editId").value;
                const name = document.getElementById("editName").value;
                const euro = parseInt(document.getElementById("editEuro").value, 10) || 0;
                const cent = parseInt(document.getElementById("editCent").value, 10) || 0;
                const price = euro + cent / 100;
                const image = document.getElementById("editImage").value;
                const days = document.getElementById("editDays").value;
                const visibility = document.getElementById("toggleVisibilityBtn").checked;

                const data = { id, name, price, image, days, visibility };

                fetch('/api/editentry', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                .then(response => {
                    if (response.ok) {
                        modal.style.display = "none";
                        window.location.reload();
                    } else {
                        alert("Fehler beim Speichern des Eintrags.");
                    }
                })
                .catch(error => console.error('Error:', error));
            });

            document.getElementById('editEuro').addEventListener('focus', function() {
                this.select();
            });

            document.getElementById('editEuro').addEventListener('input', function() {
                if (this.value.length >= 1) {
                    const centField = document.getElementById('editCent');
                    centField.focus();
                    centField.select();
                }
            });

            document.getElementById('editCent').addEventListener('focus', function() {
                this.select();
            });

            document.getElementById('editCent').addEventListener('input', function() {
                if (this.value.length > 2) {
                    this.value = this.value.slice(0, 2);
                }
            });

            document.getElementById("logoutBtn").addEventListener("click", function() {
                document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                window.location.href = "/ui/login";
            });
        });

        document.getElementById("newbtn").addEventListener("click", function() {
            window.location.href = "/panel/offers/new"; // Redirect to new entry page
        });

        document.getElementById("refreshbtn").addEventListener("click", function() {
            window.location.href = "/panel?intent=refresh"; // Refresh the page
        });

        function deleteEntry(id) {
            if (confirm("Möchten Sie diesen Eintrag wirklich löschen?")) {
                fetch(`/api/deleteoffer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: id }),
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload(); // Reload the page to see changes
                    } else {
                        alert("Fehler beim Löschen des Eintrags.");
                    }
                });
            }
        }

        document.getElementById("logoutBtn").addEventListener("click", function() {
            // Clear the token cookie
            document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            // Redirect to the login page
            window.location.href = "/ui/login";
        });

        // On page load, check if the modal should be opened
        if (localStorage.getItem('modalOpen') === 'true') {
            // Open the modal if needed
            // You can call openEditModal with the appropriate item here
            localStorage.removeItem('modalOpen'); // Clear the flag after opening
        }
        function toggleDropdown() {
            const dropdownList = document.getElementById("imageDropdownList");
            dropdownList.style.display = dropdownList.style.display === "none" ? "block" : "none";
        }

        // Attach the toggle function to the selected image area
        document.getElementById("selectedImage").onclick = toggleDropdown;

        const toggle = document.querySelector('#toggleVisibilityBtn'); // Get the toggle input

        toggle.addEventListener('change', () => {
            const toggleText = document.querySelector('.toggleVisibilityTxt');
            toggleText.textContent = toggle.checked ? 'Wird angezeigt' : 'Wird nicht angezeigt';
        });
    </script>
</body>
</html>
